
<app-navbar></app-navbar>

<h4 class="titulo-usuarios">Cuentas de usuarios</h4>

<!-- Selector de cantidad -->
  <div class="pagination-controls">
    <label for="pageSize">Usuarios por página:</label>
    <select id="pageSize" [(ngModel)]="selectedPageSize" (ngModelChange)="changePageSize($event)">
      <option *ngFor="let size of pageSizeOptions" [value]="size">{{size}}</option>
    </select>
  </div>

<!-- Contenedor general de controles -->
<div class="controls-bar">

<!-- Filtros + Botón -->
<div class="row align-items-end mb-0">
  <div class="col-md-3 mb-2">
    <label class="form-label">Filtrar por email</label>
    <input
      type="text"
      class="form-control"
      placeholder="Email"
      [(ngModel)]="emailFilter"
      (ngModelChange)="onFilterChange()"
    />
  </div>

  <div class="col-md-2 mb-2">
    <label class="form-label">Estado</label>
    <select
      class="form-select"
      [(ngModel)]="estadoFilter"
      (ngModelChange)="onFilterChange()"
    >
      <option value="">-- Todos los estados --</option>
      <option value="HABILITADO">HABILITADO</option>
      <option value="DESHABILITADO">DESHABILITADO</option>
      <option value="PENDIENTE">PENDIENTE</option>
    </select>
  </div>

  <div class="col-md-2 mb-2">
    <label class="form-label">Tipo</label>
    <select
      class="form-select"
      [(ngModel)]="tipoFilter"
      (ngModelChange)="onFilterChange()"
    >
      <option value="">-- Todos los tipos --</option>
      <option value="Personal de Salud">Personal de Salud</option>
      <option value="Miembro de Organización Civil">Miembro de Organización Civil</option>
      <option value="Admin">Admin</option>
    </select>
  </div>

  <div class="col-md-3 mb-2">
    <label class="form-label">Organización</label>
    <select
      class="form-select"
      [(ngModel)]="organizacionFilter"
      (ngModelChange)="onFilterChange()"
    >
      <option value="">-- Todas las organizaciones --</option>
      <option *ngFor="let org of organizaciones" [value]="org.nombre">
        {{ org.nombre }}
      </option>
    </select>
  </div>

  <!-- Botón Añadir usuario -->
  <div class="col-md-2 mb-2" *ngIf="userRole === 'admin'">
    <div class="d-grid">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
        <i class="bi bi-plus"></i> Añadir usuario
      </button>
    </div>
  </div>
</div>

<!-- Modal Añadir Usuario -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title" id="addUserModalLabel">Añadir nuevo usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <form>

          <div class="mb-3">
            <label for="nombre" class="form-label">Nombre</label>
            <input type="text" class="form-control" id="nombre" [(ngModel)]="newUser.nombre" name="nombre">
          </div>

          <div class="mb-3">
            <label for="apellido" class="form-label">Apellido</label>
            <input type="text" class="form-control" id="apellido" [(ngModel)]="newUser.apellido" name="apellido">
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" [(ngModel)]="newUser.email" name="email">
          </div>

          <div class="mb-3"> 
            <label for="password" class="form-label">Contraseña</label>
            <input type="password" class="form-control" id="password" [(ngModel)]="newUser.password" name="password" />
          </div>
          
          <!-- Administrador -->
          <div class="mb-3">
            <label>
              <input
                type="checkbox"
                [(ngModel)]="newUser.admin"
                name="admin"
                (change)="onAdminChange()"
              />
              <span>Administrador</span>
            </label>
          </div>

          <!-- Personal de Salud -->
          <div class="mb-3">
            <label>
              <input
                type="checkbox"
                [(ngModel)]="newUser.personalSalud"
                name="personalSalud"
                [disabled]="newUser.admin"
                (change)="onPersonalSaludChange()"
              />
              <span>Personal de Salud</span>
            </label>

            <div *ngIf="newUser.personalSalud" class="mt-2">
              <input
                type="number"
                placeholder="Número de matrícula"
                [(ngModel)]="newUser.matricula"
                name="matricula"
                class="form-control"
              />
            </div>
          </div>

          <!-- Miembro de Organización -->
          <div class="mb-3">
            <label>
              <input
                type="checkbox"
                [(ngModel)]="newUser.miembroOrg"
                name="miembroOrg"
                [disabled]="newUser.admin"
                (change)="onMiembroOrgChange()"
              />
              <span>Miembro de una organización</span>
            </label>

            <select
              *ngIf="newUser.miembroOrg"
              [(ngModel)]="newUser.organizacion"
              name="organizacion"
              class="form-select mt-2"
            >
              <option disabled selected value="">Organización social</option>
              <option *ngFor="let org of organizaciones" [ngValue]="org">
                {{ org.nombre }}
              </option>
            </select>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="cancelar()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="guardarNuevoUsuario()">Guardar</button>
      </div>

    </div>
  </div>
</div>

<table class="table table-striped table-bordered table-hover table-sm">
    <tbody>
        <tr *ngFor="let user of paginatedUsers">
            <td class="align-middle text-center fw-semibold">{{ user.email }}</td>

            <td class="align-middle text-center fw-semibold">
              {{ user.nombre }} {{ user.apellido }}
            </td>

            <td class="align-middle text-center">
              <span class="badge text-dark bg-light px-3 py-2 fw-semibold">
                {{
                  user.matricula && user.organizacion
                    ? 'Personal de Salud / ' + user.organizacion.nombre
                    : user.matricula
                    ? 'Personal de Salud'
                    : user.organizacion
                    ? user.organizacion.nombre
                    : 'Admin'
                }}
              </span>
            </td>
            <td class="align-middle text-center">
              <div class="d-flex justify-content-center align-items-center" style="height: 100%;">
                <span
                  class="badge px-3 py-2 text-dark"
                  [ngClass]="{
                    'bg-success': user.estado === 'HABILITADO',
                    'bg-danger': user.estado === 'DESHABILITADO',
                    'bg-warning': user.estado === 'PENDIENTE'
                  }"
                >
                  {{ user.estado }}
                </span>
              </div>
            </td>
            <td *ngIf="currentUserRole === 'admin'"> 
              <div class="mb-2 d-flex justify-content-around" *ngIf="user.id != currentUserId">
                <button class="btn btn-outline-secondary" title="Ver" (click)="viewUser(user.id)">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-danger" title="Eliminar" (click)="confirmDelete(user.id)">
                  <i class="bi bi-trash"></i>
                </button>  
              </div>
            </td>
        </tr>
    </tbody>
</table>


<nav class="mt-3 w-100 d-flex justify-content-center">
  <ul class="pagination justify-content-center">
    <li class="page-item" [class.disabled]="currentPage === 1">
      <button class="page-link" (click)="prevPage()" [disabled]="currentPage === 1">Anterior</button>
    </li>
    <li class="page-item disabled">
      <span class="page-link">Página {{ currentPage }}</span>
    </li>
    <li class="page-item" [class.disabled]="(currentPage * selectedPageSize) >= getFilteredUsers().length">
      <button
        class="page-link"
        (click)="nextPage()"
        [disabled]="(currentPage * selectedPageSize) >= getFilteredUsers().length"
      >
        Siguiente
      </button>
    </li>
  </ul>
</nav>
